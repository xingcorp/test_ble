package com.nordicbeacon.scanner.presentation

import android.Manifest
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.result.contract.ActivityResultContracts
import androidx.activity.viewModels
import androidx.core.app.ActivityCompat
import androidx.lifecycle.lifecycleScope
import com.nordicbeacon.scanner.R
import com.nordicbeacon.scanner.infrastructure.services.BeaconScanningService
import com.nordicbeacon.scanner.presentation.viewmodels.BeaconScanViewModel
import com.nordicbeacon.scanner.infrastructure.oem.coordination.BatteryOptimizationCoordinator
import com.nordicbeacon.scanner.infrastructure.oem.education.UserEducationHelper
import com.nordicbeacon.scanner.infrastructure.workers.BeaconScanWorker
import com.nordicbeacon.scanner.analytics.AnalyticsIntegrationManager
import com.nordicbeacon.scanner.analytics.dashboard.AnalyticsDashboardActivity
import com.nordicbeacon.scanner.core.permissions.PermissionManager
import com.nordicbeacon.scanner.core.permissions.PermissionGroups
import com.nordicbeacon.scanner.core.permissions.PermissionResult
import androidx.work.WorkManager
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.launch
import timber.log.Timber
import javax.inject.Inject

/**
 * üì± Main Activity - Nordic Beacon Scanner
 * 
 * Primary UI entry point cho Nordic beacon scanning application
 * Handles permission flow v√† service lifecycle management
 * 
 * Key Features:
 * - Multi-version permission handling (API 21 ‚Üí 34)
 * - Professional permission education flow
 * - Service lifecycle management
 * - Real-time beacon detection display
 * - Error handling v·ªõi user-friendly messages
 * 
 * @author Senior Android Developer
 */
@AndroidEntryPoint
class MainActivity : ComponentActivity() {

    // ========== VIEW MODEL & STATE ==========
    
    private val viewModel: BeaconScanViewModel by viewModels()
    
    @Inject lateinit var batteryOptimizationCoordinator: BatteryOptimizationCoordinator
    @Inject lateinit var userEducationHelper: UserEducationHelper
    @Inject lateinit var analyticsIntegrationManager: AnalyticsIntegrationManager
    @Inject lateinit var permissionManager: PermissionManager
    
    // ========== PERMISSION HANDLING (NEW SYSTEM) ==========
    
    // Old permission launcher (deprecated - replaced with new fluent API)
    /*
    private val permissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        handlePermissionResults(permissions)
    }
    */

    // ========== ACTIVITY LIFECYCLE ==========

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        Timber.i("üì± MainActivity created")
        Timber.i("üéØ Target Nordic UUID: ${com.nordicbeacon.scanner.domain.entities.NordicBeacon.NORDIC_UUID}")
        
        // For now, simple content view - will implement proper UI layout later
        setContentView(R.layout.activity_main)
        
        // Initialize analytics system
        initializeAnalytics()
        
        // Initialize UI v√† observers
        initializeUI()
        observeViewModel()
        
        // Check permissions v√† start scanning if ready
        checkPermissionsAndStartScanning()
        
        // Handle battery optimization intent action
        handleBatteryOptimizationIntent(intent)
    }

    override fun onResume() {
        super.onResume()
        Timber.d("üì± MainActivity resumed")
        
        // Check if service is still running
        viewModel.checkServiceStatus()
    }

    override fun onPause() {
        super.onPause()
        Timber.d("üì± MainActivity paused")
    }

    override fun onDestroy() {
        super.onDestroy()
        Timber.i("üì± MainActivity destroyed")
    }

    // ========== UI INITIALIZATION ==========

    /**
     * üé® Initialize UI components
     */
    private fun initializeUI() {
        Timber.d("üé® Initializing UI components...")
        
        // Initialize button click listeners (layout already set trong onCreate)
        findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_start_scanning)?.setOnClickListener {
            Timber.i("üöÄ Start scanning button clicked")
            startBeaconScanning()
        }
        
        findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_stop_scanning)?.setOnClickListener {
            Timber.i("‚èπÔ∏è Stop scanning button clicked") 
            stopBeaconScanning()
        }
        
        findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_clear_history)?.setOnClickListener {
            Timber.i("üßπ Clear history button clicked")
            clearDetectionHistory()
        }
        
        findViewById<com.google.android.material.floatingactionbutton.FloatingActionButton>(R.id.fab_scan_toggle)?.setOnClickListener {
            Timber.i("üì± FAB scan toggle clicked")
            toggleScanning()
        }
        
        Timber.i("‚úÖ UI components initialized v·ªõi click listeners")
    }

    /**
     * üëÅÔ∏è Setup ViewModel observers
     */
    private fun observeViewModel() {
        Timber.d("üëÅÔ∏è Setting up ViewModel observers...")
        
        // Observe scanning state
        lifecycleScope.launch {
            viewModel.scanningState.collect { state ->
                Timber.i("üîÑ Scanning state changed: $state")
                handleScanningStateChange(state)
            }
        }
        
        // Observe beacon detections
        lifecycleScope.launch {
            viewModel.beaconDetections.collect { beacons ->
                if (beacons.isNotEmpty()) {
                    Timber.i("üéØ Received ${beacons.size} beacon detection(s)")
                    handleBeaconDetections(beacons)
                }
            }
        }
        
        // Observe permission status
        lifecycleScope.launch {
            viewModel.permissionStatus.collect { status ->
                Timber.d("üîê Permission status updated: $status")
                handlePermissionStatusChange(status)
            }
        }
        
        // Observe errors
        lifecycleScope.launch {
            viewModel.errors.collect { error ->
                error?.let {
                    Timber.e("‚ùå ViewModel error: ${it.message}")
                    handleViewModelError(it)
                }
            }
        }
        
        Timber.i("‚úÖ ViewModel observers setup completed")
    }

    // ========== PERMISSION MANAGEMENT ==========

    /**
     * üîê Check permissions v√† start scanning process (New System)
     */
    private fun checkPermissionsAndStartScanning() {
        Timber.i("üîê Checking required Nordic BLE scanning permissions...")
        
        // Use new fluent permission API
        permissionManager
            .with(this)
            .request(*PermissionGroups.BLE_SCANNING_COMPLETE.toTypedArray())
            .educate(true)
            .rationale(
                "Nordic Beacon Scanning", 
                "This app requires Bluetooth and location permissions to detect Nordic beacons in your area."
            )
            .onGranted { result ->
                Timber.i("‚úÖ All Nordic scanning permissions granted: ${result.permissions.size}")
                startBeaconScanningService()
            }
            .onDenied { result ->
                handlePermissionDenialResult(result)
            }
            .onError { error ->
                Timber.e("‚ùå Permission request error: ${error.exception}")
                showPermissionErrorDialog(error)
            }
            .check()
    }

    /**
     * üéØ Request BLE permissions using new system
     */
    private fun requestBlePermissions() {
        permissionManager
            .with(this)
            .request(*PermissionGroups.BLE_SCANNING_ESSENTIAL.toTypedArray())
            .educate(true)
            .rationale("Nordic BLE Scanning", "Required for Nordic beacon detection")
            .onResult { result ->
                handlePermissionResult(result)
            }
            .check()
    }

    /**
     * üîÑ Handle permission result from new system
     */
    private fun handlePermissionResult(result: PermissionResult) {
        when (result) {
            is PermissionResult.Granted -> {
                Timber.i("‚úÖ Permissions granted: ${result.permissions.size}")
                startBeaconScanningService()
            }
            is PermissionResult.Denied -> {
                handlePermissionDenialResult(result)
            }
            is PermissionResult.Cancelled -> {
                Timber.w("‚èπÔ∏è Permission request cancelled")
                showPermissionImportanceDialog()
            }
            is PermissionResult.Error -> {
                Timber.e("‚ùå Permission error: ${result.exception}")
                showPermissionErrorDialog(result)
            }
        }
    }

    /**
     * ‚ùå Handle permission denial with smart responses
     */
    private fun handlePermissionDenialResult(result: PermissionResult.Denied) {
        when (result.getRecommendedAction()) {
            com.nordicbeacon.scanner.core.permissions.PermissionAction.OPEN_SETTINGS -> {
                showPermissionSettingsDialog()
            }
            com.nordicbeacon.scanner.core.permissions.PermissionAction.REQUEST_AGAIN -> {
                showRetryPermissionDialog()
            }
            else -> {
                if (result.hasPartialGrant) {
                    showPartialPermissionDialog(result.grantedPermissions)
                } else {
                    showPermissionSettingsDialog()
                }
            }
        }
    }

    /**
     * ‚ö†Ô∏è Show permission error dialog
     */
    private fun showPermissionErrorDialog(error: PermissionResult.Error) {
        try {
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("Permission Error")
                .setMessage("Error requesting permissions: ${error.exception.message}")
                .setPositiveButton("Try Again") { _, _ -> checkPermissionsAndStartScanning() }
                .setNegativeButton("Cancel") { dialog, _ -> dialog.dismiss() }
                .show()
        } catch (e: Exception) {
            Timber.e(e, "Failed to show error dialog")
        }
    }

    /**
     * üîÑ Show retry permission dialog
     */
    private fun showRetryPermissionDialog() {
        try {
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("üîê Nordic Beacon Permissions")
                .setMessage("Nordic beacon detection needs Bluetooth and location permissions.\n\nWould you like to try granting them again?")
                .setPositiveButton("‚úÖ Try Again") { _, _ -> requestBlePermissions() }
                .setNeutralButton("‚öôÔ∏è Settings") { _, _ -> openAppSettings() }
                .setNegativeButton("Cancel") { dialog, _ -> dialog.dismiss() }
                .show()
        } catch (e: Exception) {
            Timber.e(e, "Failed to show retry dialog")
        }
    }

    /**
     * üéØ Show partial permission dialog
     */
    private fun showPartialPermissionDialog(grantedPermissions: List<com.nordicbeacon.scanner.core.permissions.Permission>) {
        try {
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("‚ö†Ô∏è Partial Permissions")
                .setMessage("Some permissions granted (${grantedPermissions.size}), but Nordic scanning needs all permissions for optimal detection.\n\nContinue with limited functionality?")
                .setPositiveButton("üöÄ Continue") { _, _ -> startBeaconScanningService() }
                .setNeutralButton("üîÑ Request All") { _, _ -> requestBlePermissions() }
                .setNegativeButton("Cancel") { dialog, _ -> dialog.dismiss() }
                .show()
        } catch (e: Exception) {
            Timber.e(e, "Failed to show partial permission dialog")
        }
    }

    /**
     * ‚ÑπÔ∏è Show permission importance dialog
     */
    private fun showPermissionImportanceDialog() {
        try {
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("üéØ Nordic Beacon Detection")
                .setMessage("This app is specifically designed for Nordic beacon scanning.\n\nWithout Bluetooth and location permissions, the app cannot function.\n\nWould you like to grant permissions now?")
                .setPositiveButton("‚úÖ Grant") { _, _ -> requestBlePermissions() }
                .setNegativeButton("Exit") { _, _ -> finish() }
                .setCancelable(false)
                .show()
        } catch (e: Exception) {
            Timber.e(e, "Failed to show importance dialog")
        }
    }

    // ========== OLD PERMISSION METHODS (DEPRECATED) ==========
    // These methods are kept commented for reference but replaced with new system
    
    /*
     * üôè Request missing permissions t·ª´ user (Sequential Strategy) - OLD SYSTEM
     */
    /*
    private fun requestMissingPermissions() {
        val permissionStatus = permissionManager.getSequentialPermissionStatus()
        
        // If can already start basic scanning, inform user
        if (permissionStatus.canStartScanning) {
            Timber.i("‚úÖ Basic scanning permissions available - can start Nordic detection")
            // Continue v·ªõi available permissions
            return
        }
        
        // Get next permission step to request
        val nextStep = permissionStatus.currentStep
        if (nextStep == null) {
            Timber.i("‚úÖ All permissions granted!")
            return
        }
        
        Timber.i("üîÑ Sequential permission request - Step: ${nextStep.description}")
        
        // Request specific step permissions
        val stepPermissions = permissionManager.getPermissionsForStep(nextStep)
        
        // Check if we should show rationale
        val shouldShowRationale = stepPermissions.any { permission ->
            shouldShowRequestPermissionRationale(permission)
        }
        
        if (shouldShowRationale) {
            // Show educational dialog cho this step
            showPermissionStepDialog(nextStep, stepPermissions)
        } else {
            // Permissions likely blocked - direct to settings
            Timber.w("‚ö†Ô∏è Permission dialogs blocked - directing to Settings")
            showPermissionSettingsDialog()
        }
    }
    */

    /*
     * üìö Show educational dialog cho specific permission step - OLD SYSTEM
     */
    /*
    private fun showPermissionStepDialog(step: PermissionStep, permissions: Array<String>) {
        try {
            val builder = androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("üîê ${step.description}")
                .setMessage("""
                    ${step.userExplanation}
                    
                    üìã Permissions needed:
                    ${permissions.joinToString("\n") { "‚Ä¢ ${permissionManager.getPermissionDisplayName(it)}" }}
                    
                    üí° This step enables Nordic beacon detection functionality.
                """.trimIndent())
                .setPositiveButton("‚úÖ Grant") { _, _ ->
                    Timber.i("üîÑ Requesting step permissions: ${permissions.joinToString()}")
                    permissionLauncher.launch(permissions)
                }
                .setNegativeButton("‚öôÔ∏è Settings") { _, _ ->
                    showPermissionSettingsDialog()
                }
                .setCancelable(true)
            
            builder.create().show()
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to show step dialog")
            permissionLauncher.launch(permissions)
        }
    }
    */

    /*
     * üìù Handle permission request results - OLD SYSTEM
     */
    /*
    private fun handlePermissionResults(permissions: Map<String, Boolean>) {
        val granted = permissions.filterValues { it }.keys
        val denied = permissions.filterValues { !it }.keys
        
        Timber.i("‚úÖ Permissions granted: $granted")
        Timber.w("‚ùå Permissions denied: $denied")
        
        handleGrantedPermissions(granted.toList())
        if (denied.isNotEmpty()) {
            handleDeniedPermissions(denied.toList())
        }
        
        // Continue sequential flow - check if more permissions needed
        val permissionStatus = permissionManager.getSequentialPermissionStatus()
        if (permissionStatus.currentStep != null && granted.isNotEmpty()) {
            // Some granted, continue v·ªõi next step
            Timber.i("üîÑ Continuing sequential permission flow...")
            requestMissingPermissions()
        } else if (permissionStatus.hasOptimalPermissions) {
            // All permissions granted - start scanning!
            Timber.i("üéâ All permissions granted - starting Nordic beacon scanning!")
            startBeaconScanningService()
        } else if (permissionStatus.canStartScanning) {
            // Can start v·ªõi basic permissions
            Timber.i("üöÄ Basic permissions sufficient - can start Nordic scanning")
            showBasicScanningDialog()
        }
    }
    */

    /**
     * üö´ Handle denied permissions scenario
     */
    private fun handlePermissionsDenied(deniedPermissions: List<String>) {
        Timber.w("üö´ Handling denied permissions: $deniedPermissions")
        
        // TODO: Show appropriate user education dialogs
        // TODO: Implement graceful degradation strategies
        
        // For critical permissions, app cannot function
        val criticalPermissions = listOf(
            Manifest.permission.ACCESS_FINE_LOCATION,
            Manifest.permission.BLUETOOTH_SCAN,
            Manifest.permission.BLUETOOTH
        )
        
        val hasCriticalDenials = deniedPermissions.any { it in criticalPermissions }
        
        if (hasCriticalDenials) {
            Timber.e("‚ùå Critical permissions denied - app cannot function properly")
            showPermissionSettingsDialog()
        }
    }

    /**
     * ‚öôÔ∏è Show dialog to direct user to Settings cho manual permission grant
     */
    private fun showPermissionSettingsDialog() {
        Timber.i("‚öôÔ∏è Showing permission settings guidance dialog...")
        
        try {
            val builder = androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("üîê Nordic Beacon Scanner - Permissions Required")
                .setMessage("""
                    üéØ Nordic beacon detection requires these permissions:
                    
                    üìç Location: "Allow all the time"
                    üì° Bluetooth: "Allow nearby devices"  
                    üîã Background: "Allow background activity"
                    
                    ‚öôÔ∏è Please grant manually:
                    Settings ‚Üí Apps ‚Üí Nordic Beacon Scanner ‚Üí Permissions
                    
                    üí° These permissions enable continuous Nordic beacon scanning even when your screen is off.
                """.trimIndent())
                .setPositiveButton("üîß Open Settings") { _, _ ->
                    openAppSettings()
                }
                .setNegativeButton("üì± Later") { dialog, _ ->
                    dialog.dismiss()
                    Timber.i("‚è∏Ô∏è User chose to configure permissions later")
                }
                .setCancelable(true)
            
            builder.create().show()
            
            Timber.i("‚úÖ Permission guidance dialog displayed")
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to show permission dialog")
            // Fallback: Direct to settings
            openAppSettings()
        }
    }

    /**
     * ‚öôÔ∏è Open app settings cho manual permission configuration
     */
    private fun openAppSettings() {
        try {
            val intent = android.content.Intent().apply {
                action = android.provider.Settings.ACTION_APPLICATION_DETAILS_SETTINGS
                data = android.net.Uri.fromParts("package", packageName, null)
                flags = android.content.Intent.FLAG_ACTIVITY_NEW_TASK
            }
            startActivity(intent)
            Timber.i("‚öôÔ∏è Opened app settings cho manual permission configuration")
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to open app settings")
        }
    }

    /**
     * ‚úÖ Handle granted permissions
     */
    private fun handleGrantedPermissions(grantedPermissions: List<String>) {
        if (grantedPermissions.isNotEmpty()) {
            Timber.i("‚úÖ Successfully granted: ${grantedPermissions.joinToString(", ")}")
            
            // Log permission step completion
            grantedPermissions.forEach { permission ->
                Timber.d("‚úÖ Permission granted: ${permissionManager.getPermissionDisplayName(permission)}")
            }
        }
    }

    /**
     * ‚ùå Handle denied permissions
     */
    private fun handleDeniedPermissions(deniedPermissions: List<String>) {
        Timber.w("üö´ Handling denied permissions: $deniedPermissions")
        
        // Check if critical permissions are denied
        val criticalPermissions = listOf(
            Manifest.permission.ACCESS_FINE_LOCATION,
            Manifest.permission.BLUETOOTH_SCAN,
            Manifest.permission.BLUETOOTH,
            Manifest.permission.BLUETOOTH_ADMIN
        )
        
        val hasCriticalDenials = deniedPermissions.any { it in criticalPermissions }
        
        if (hasCriticalDenials) {
            Timber.e("‚ùå Critical permissions denied - app cannot function properly")
            // Continue sequential flow will handle this v·ªõi Settings dialog
        }
    }

    /**
     * üì± Show dialog when basic scanning permissions available
     */
    private fun showBasicScanningDialog() {
        try {
            val builder = androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("üöÄ Nordic Scanning Ready")
                .setMessage("""
                    ‚úÖ Basic Nordic beacon scanning is now available!
                    
                    üìç Current permissions allow foreground detection
                    üîã For background scanning (screen off), grant background location permission
                    
                    üéØ Start Nordic beacon detection now?
                """.trimIndent())
                .setPositiveButton("üöÄ Start Scanning") { _, _ ->
                    startBeaconScanningService()
                }
                .setNegativeButton("‚öôÔ∏è Get Full Permissions") { _, _ ->
                    requestMissingPermissions() // Continue sequential flow
                }
                .setCancelable(true)
            
            builder.create().show()
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to show basic scanning dialog")
            startBeaconScanningService() // Fallback
        }
    }

    // ========== SERVICE MANAGEMENT ==========

    /**
     * üöÄ Start beacon scanning service
     */
    private fun startBeaconScanningService() {
        try {
            val serviceIntent = BeaconScanningService.createStartIntent(this)
            
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                startForegroundService(serviceIntent)
            } else {
                startService(serviceIntent)
            }
            
            Timber.i("üöÄ Nordic beacon scanning service started")
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to start beacon scanning service")
            handleServiceStartError(e)
        }
    }

    /**
     * ‚èπÔ∏è Stop beacon scanning service
     */
    private fun stopBeaconScanningService() {
        try {
            val serviceIntent = BeaconScanningService.createStopIntent(this)
            startService(serviceIntent)
            
            Timber.i("‚èπÔ∏è Nordic beacon scanning service stop requested")
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to stop beacon scanning service")
        }
    }

    // ========== EVENT HANDLERS ==========

    /**
     * üîÑ Handle scanning state changes
     */
    private fun handleScanningStateChange(state: com.nordicbeacon.scanner.domain.models.ScanningState) {
        when (state) {
            com.nordicbeacon.scanner.domain.models.ScanningState.SCANNING -> {
                Timber.i("‚úÖ Scanning state: ACTIVE")
                // TODO: Update UI to show active scanning state
            }
            com.nordicbeacon.scanner.domain.models.ScanningState.STOPPED -> {
                Timber.i("‚èπÔ∏è Scanning state: STOPPED")  
                // TODO: Update UI to show stopped state
            }
            com.nordicbeacon.scanner.domain.models.ScanningState.ERROR -> {
                Timber.w("‚ùå Scanning state: ERROR")
                // TODO: Show error state in UI
            }
            else -> {
                Timber.d("üîÑ Scanning state: $state")
            }
        }
    }

    /**
     * üéØ Handle beacon detections
     */
    private fun handleBeaconDetections(beacons: List<com.nordicbeacon.scanner.domain.entities.NordicBeacon>) {
        Timber.i("üéØ Processing ${beacons.size} Nordic beacon detection(s)")
        
        beacons.forEach { beacon ->
            Timber.i("   üì° ${beacon.uuid.value} | ${beacon.signalStrength.rssi}dBm | ${"%.2f".format(beacon.proximity.meters)}m")
        }
        
        // TODO: Update UI v·ªõi beacon detection list
    }

    /**
     * üîê Handle permission status changes
     */
    private fun handlePermissionStatusChange(status: Any) {
        // TODO: Implement when PermissionStatus model is defined
        Timber.d("üîê Permission status changed")
    }

    // ========== UI ACTION HANDLERS ==========

    /**
     * üöÄ Start beacon scanning (New System)
     */
    private fun startBeaconScanning() {
        Timber.i("üöÄ Starting Nordic beacon scanning...")
        
        // Check permissions using new system
        lifecycleScope.launch {
            val hasPermissions = permissionManager.arePermissionsGranted(
                *PermissionGroups.BLE_SCANNING_ESSENTIAL.toTypedArray()
            )
            
            if (!hasPermissions) {
                Timber.w("‚ö†Ô∏è Missing required permissions - requesting...")
                requestBlePermissions()
                return@launch
            }
            
            // Start the beacon scanning service
            try {
                val intent = BeaconScanningService.createStartIntent(this@MainActivity)
                startService(intent)
                
                // Update UI state
                findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_start_scanning)?.apply {
                    isEnabled = false
                }
                findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_stop_scanning)?.apply {
                    isEnabled = true
                }
                
                Timber.i("‚úÖ Nordic beacon scanning started successfully")
                
            } catch (e: Exception) {
                Timber.e(e, "‚ùå Failed to start beacon scanning")
            }
        }
    }

    /**
     * ‚èπÔ∏è Stop beacon scanning  
     */
    private fun stopBeaconScanning() {
        Timber.i("‚èπÔ∏è Stopping Nordic beacon scanning...")
        
        lifecycleScope.launch {
            try {
                val intent = BeaconScanningService.createStopIntent(this@MainActivity)
                startService(intent)
                
                // Update UI state
                findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_start_scanning)?.apply {
                    isEnabled = true
                }
                findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_stop_scanning)?.apply {
                    isEnabled = false
                }
                
                Timber.i("‚úÖ Nordic beacon scanning stopped")
                
            } catch (e: Exception) {
                Timber.e(e, "‚ùå Failed to stop beacon scanning")
            }
        }
    }

    /**
     * üßπ Clear detection history
     */
    private fun clearDetectionHistory() {
        Timber.i("üßπ Clearing detection history...")
        
        lifecycleScope.launch {
            try {
                // Clear via ViewModel
                viewModel.clearDetectionHistory()
                
                // Update UI
                findViewById<android.widget.TextView>(R.id.txt_detection_count)?.text = "0"
                
                Timber.i("‚úÖ Detection history cleared")
                
            } catch (e: Exception) {
                Timber.e(e, "‚ùå Failed to clear detection history")
            }
        }
    }

    /**
     * üîÑ Toggle scanning state
     */
    private fun toggleScanning() {
        Timber.i("üîÑ Toggling scanning state...")
        
        val startButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_start_scanning)
        val isCurrentlyScanning = startButton?.isEnabled == false
        
        if (isCurrentlyScanning) {
            stopBeaconScanning()
        } else {
            startBeaconScanning()
        }
    }

    /**
     * ‚ùå Handle ViewModel errors
     */
    private fun handleViewModelError(error: Throwable) {
        Timber.e(error, "‚ùå ViewModel error occurred")
        
        // TODO: Show appropriate error dialog to user
        // TODO: Implement error recovery actions
    }

    /**
     * ‚ùå Handle service start errors
     */
    private fun handleServiceStartError(error: Exception) {
        Timber.e(error, "‚ùå Service start error")
        
        // TODO: Show error dialog v·ªõi retry option
        // TODO: Implement fallback strategies
    }

    /**
     * üîã Handle battery optimization intent action
     */
    private fun handleBatteryOptimizationIntent(intent: Intent?) {
        
        if (intent?.action == "ACTION_BATTERY_OPTIMIZATION") {
            Timber.i("üîã Battery optimization action requested t·ª´ notification")
            
            lifecycleScope.launch {
                try {
                    // Execute battery optimization flow
                    val result = batteryOptimizationCoordinator.executeOptimization()
                    
                    when (result) {
                        is com.nordicbeacon.scanner.infrastructure.oem.models.BatteryOptimizationResult.AlreadyOptimized -> {
                            Timber.i("‚úÖ Device already optimized")
                            // TODO: Show success message
                        }
                        
                        is com.nordicbeacon.scanner.infrastructure.oem.models.BatteryOptimizationResult.SettingsOpened -> {
                            Timber.i("‚öôÔ∏è Settings opened: ${result.settingsType}")
                            // TODO: Show user guidance dialog
                        }
                        
                        is com.nordicbeacon.scanner.infrastructure.oem.models.BatteryOptimizationResult.Failed -> {
                            Timber.w("‚ùå Optimization failed: ${result.reason}")
                            // TODO: Show fallback instructions
                        }
                        
                        else -> {
                            Timber.d("‚ÑπÔ∏è Optimization result: ${result::class.simpleName}")
                        }
                    }
                    
                } catch (e: Exception) {
                    Timber.e(e, "‚ùå Battery optimization flow failed")
                    // TODO: Show error dialog
                }
            }
        }
    }

    /**
     * üîÑ Setup WorkManager backup scanning
     */
    private fun setupWorkManagerBackup() {
        try {
            val workRequest = BeaconScanWorker.createPeriodicWorkRequest()
            
            WorkManager.getInstance(this)
                .enqueueUniquePeriodicWork(
                    BeaconScanWorker.WORK_NAME,
                    androidx.work.ExistingPeriodicWorkPolicy.KEEP, // Don't restart if already running
                    workRequest
                )
            
            Timber.i("üîÑ WorkManager backup scanning scheduled")
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to setup WorkManager backup")
        }
    }

    /**
     * üî¨ Initialize analytics system
     */
    private fun initializeAnalytics() {
        try {
            analyticsIntegrationManager.initializeAnalytics()
            
            // Setup analytics observers
            setupAnalyticsObservers()
            
            Timber.i("üî¨ Analytics system initialized")
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Analytics initialization failed")
        }
    }

    /**
     * üëÅÔ∏è Setup analytics data observers
     */
    private fun setupAnalyticsObservers() {
        lifecycleScope.launch {
            analyticsIntegrationManager.enhancedBeacons
                .collect { enhancedBeacon ->
                    handleEnhancedBeaconDetection(enhancedBeacon)
                }
        }
        
        lifecycleScope.launch {
            analyticsIntegrationManager.analyticsInsights
                .collect { insights ->
                    insights?.let { handleAnalyticsInsights(it) }
                }
        }
    }

    /**
     * üéØ Handle enhanced beacon detection v·ªõi analytics
     */
    private fun handleEnhancedBeaconDetection(enhancedBeacon: com.nordicbeacon.scanner.analytics.EnhancedNordicBeacon) {
        val beacon = enhancedBeacon.originalBeacon
        val analytics = enhancedBeacon.analyticsData
        
        Timber.i("üéØ Enhanced beacon detected v·ªõi analytics:")
        Timber.i("   üì° Filtered RSSI: ${"%.1f".format(analytics.filteredRssi.filteredValue)}dBm (${(analytics.filteredRssi.improvementFactor * 100).toInt()}% improvement)")
        Timber.i("   üìè Enhanced Distance: ${"%.2f".format(analytics.enhancedDistance.distance)}m (${(analytics.enhancedDistance.confidence * 100).toInt()}% confidence)")
        Timber.i("   üèÜ Reliability Score: ${analytics.reliabilityScore.overallScore}%")
        
        // TODO: Update UI v·ªõi enhanced data
    }

    /**
     * üìä Handle analytics insights updates
     */
    private fun handleAnalyticsInsights(insights: com.nordicbeacon.scanner.analytics.insights.BeaconInsights) {
        Timber.i("üìä Analytics insights updated:")
        Timber.i("   üìà Total detections: ${insights.totalDetections}")
        Timber.i("   üéØ Unique beacons: ${insights.uniqueBeacons}")
        Timber.i("   üìã Recommendations: ${insights.recommendations.size}")
        
        // TODO: Update UI v·ªõi insights data
    }

    /**
     * üìä Open analytics dashboard
     */
    private fun openAnalyticsDashboard() {
        try {
            val intent = Intent(this, AnalyticsDashboardActivity::class.java)
            startActivity(intent)
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Failed to open analytics dashboard")
        }
    }
}
